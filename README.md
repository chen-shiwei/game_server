# 游戏服务器


## 大厅 Lobby

  1. 从配置服务器获取配置信息

    - 数据逻辑层的地址端口表、请求协议
	- 日志服务器的地址端口、请求协议
	- 大厅监听地址端口、状态广播地址端口。
	- 获取管理地址端口
	- 如果无法连接配置服务器则尝试直接使用本地配置缓存
  
  2. 建立本机服务资源

    - 初始化节点管理资源
    - 初始本机客户状态共用资源
	
  3. 建立服务并开启监听服务
  
  4. 打开集群通讯端口监听服务
  
  5. 打开管理通讯端口的监听
  
  6. 向集群内发送广播，声明自身加入
  
  7. 收集集群中当前在线的节点
  
    - 通过广播响应维护一个临时节点列表
	- 通过向临时节点列表中的任意两台服务器发送节点协助指令获取节点列表
	- 比对节点协助指令所获取节点列表与当前临时节点的差异
	- 根据两台服务来确定本机执有节点列表是否完整并与差异节点进行再次验证

## 游戏大厅 Lobby
  
  1. 考虑UDP协议
  2. 考虑Lobby是否与Game Room放在同一个服务中

## 游戏房间 Game Room

  根据稳定Socket连接的需求，考虑使用TCP协议进行连接。

  1. 从配置服务器获取配置信息
  2. 根据配置启动服务
  3. 初始化服务相关方法绑定
  4. 根据配置启动集群管理
  5. 调用集群节点初始化
  6. 进行准备工作

## 数据逻辑层 Data Layer

  1. 从配置服务器获取配置信息，包括缓存及数据库的配置信息、连接池的初始化。
  2. 打开数据请求接口，针对所有请求的可能设计用数据接口。
  3. 打开数据修改接口，此接口应当提供对数据操作结果进行验证的可能。
  4. 数据修改前期考虑直接操作数据库，对于直接操作的数据库表需要谨慎的设计索引。

## 配置服务器 Config Server

  配置服务器主要分为三个部分。
  
  1. 基本配置
  
    - 数据库服务配置
	- 缓存服务配置
	- 日志服务配置
	
  2. 服务配置（待设计）
  
    - Lobby 节点目录
	- Game Room 节点目录
	
  3. 升级配置
  
    - 灰度发布
	  
	  灰度升级配置，指定服务器节点升级，需要约定与服务器的升级通知方式，节点升级为自然的将本服用户做为灰度发布测试对象。
	  灰度发布配置需要包括版本号等操作，如不限制升级节点号，可以做为全局升级的配置。
	  
	- 测试用户列表
	  
	  测试用户配置可指定将某个用户请求发送至测试服务器，此配置仅在服务器集群中存在声明为测试服务器节点存在的时候才会由其它服务节点获取。

## 房间通讯协议

1. CMD_KEEPALIVE    uint8 = 0
   定时接收服务器发送的CMD为CMD_KEEPALIVE的包，并原包返回
2. CMD_USER_LOGIN   uint8 = 1
3. CMD_USER_LOGOUT  uint8 = 2
4. CMD_USER_BACK    uint8 = 3
5. CMD_CREATE_ROOM  uint8 = 11
   Param:
    type // int 1 房间类型，是聊天房间还是游戏房间
	gameId // string 游戏ID，由开发者提供
	name // string 房间名
	password // string 为房间设置密码，留空则不设置密码
   Return:
    name // 房间名，无返回意义
	roomId // string 房间Hash，roomId
6. CMD_JOIN_ROOM    uint8 = 12
   Param:
    roomId // 房间ID
	count // 房间人数限制
	password // 房间密码
   Return:
    roomId // 加入的房间Id
	playerList // Player[] 房间人员列表
   Player
    name // 用户昵称
	id // 用户id
	icon // 用户头像
7. CMD_LEAVE_ROOM   uint8 = 13
   Param:
    null
   Return:
    code // 0 为成功
	reason // string 失败原因
8. CMD_REQUEST_ROOM uint8 = 14
   参数及返回结构同rooms/landlord
